---
title: 应用层
time: 2002-06-18
category: 计算机网络
tag:
    - 应用层
    - HTTP
---

# 基础概念

任务：直接为应用程序提供服务

进行通信的实体：进程

## 套接字
应用层和运输层之间的接口，也称为应用程序编程接口（API）

## 应用层协议定义的内容

- 交换的报文类型
- 报文的语法
- 字段的定义
- 规定发送报文的时机和方式，以及响应规则

## 常见的应用层协议

- HTTP
- DNS
- SMTP
- P2P


# HTTP

## 定义
> 超文本传输协议：HyperText Transfer Protocol

- 定义了客服端与服务器的通信方式
- 使用TCP作为运输层协议。所以HTTP不需关心数据的丢失，也不关注TCP从网络的数据丢失和乱序故障中恢复的细节。
- 是一个无状态协议。即HTTP自身不对请求和响应之间的通信状态进行保存


## 非持续连接与持续连接

- ***持续连接***：建立一个TCP连接之后，所有数据都通过一个连接进行发送
- ***非持续连接***：一个TCP连接仅发送一次数据，完成后就关闭

持久连接的性能更佳。HTTP1.1以上默认采用持久连接。

关闭持久连接的方法：
```
Connection: cloase
```

## HTTP报文格式

### 请求报文

1. 报文的第一行叫做***请求行***，包括三个字段：
    - 请求方法字段
    - URL字段
    - HTTP版本字段
2. 后面的若干行叫***首部行***，分为**首部字段名**和**取值**两部分
3. 用一个空行隔开后，末尾是***请求体（entity body）***，GET方法时为空

### 响应报文

1. 第一行为***状态行***，包括三个内容：
    - HTTP版本
    - 状态码
    - 状态短语
2. 若干个***首部行***，同请求报文
3. 空行隔开后的***主体***，同请求报文


## 常见请求方法

- GET：请求数据
- POST：提交数据，数据放在请求体中
- HEAD：类似GET，但响应中没有实体，只有响应头
- PUT： 从客户端向服务器传送的数据取代指定的文档的内容
- DELETE：删除指定内容
- OPTIONS：客户端查看服务器的性能
- TRACE：用于环回测试
- PATCH：对PUT方法的补充，对已知资源进行更新

## 常见HTTP首部字段

### 通用字段

- date：报文创建的日期和时间
- cache-control：通过指令实现缓存机制。缓存指令是单向的，请求中的指令不一定包含在响应中
- connection：设置是否持久连接（默认打开）

### 请求头字段

- Host：请求的主机名（域名）
- User-Agent：创建请求的浏览器和用户代理信息
- Accept-?
    - Accept：告知服务器用户支持的媒体类型
    - Accept-Charset：字符集
    - Accept-encoding：编码方式
    - Accept-Language：语言
- Authorization：认证信息
- If-?：**条件请求**
    - If-Modified-Since：如果自该日期之后该资源更新过，则返回更新后的资源；否则返回304NOT Modified
- Range：设置请求资源的范围
- Referer：请求发起的地址（如用户点击网页上的链接进行跳转时）
>   正确拼写应为Referrer，但标准中出现了拼写错误


### 响应头字段

- Server：告知客户端服务器的信息（Apache/2.2.17）
- Last-Modified：资源的最后修改日期
- Content-Type：返回的实体的媒体类型
- Content-Length：返回的实体的大小
- Location：重定向的地址，配合3xx使用

## 常见状态码

### 2XX：成功

- 200 OK：请求已被成功处理
- 204 No Content：请求已成功处理，响应不包含body
- 206 Partial Content：成功执行范围请求

### 3XX：重定向

- 301 Moved Permanently：永久重定向，资源已被分配了新的URI，此时应使用Location字段的值进行访问
- 302 Redirect：暂时重定向
- 304 Not Modified：客户端发送条件请求，允许访问但不满足条件时（如：指定日期后未更新）

### 4XX：客户端错误

- 400 Bad Request：请求存在语法错误
- 401 Unauthorized：需要身份认证
- 403 Forbidden：请求的资源禁止访问
- 404 Not Found：请求的资源找不到

### 5XX：服务端错误

- 500 Interval Server Error：执行请求时，服务器内部出现错误。*可能是web应用内部bug*
- 503 Server Unavailable：服务器暂时处于超负荷或停机状态


## Cookie

### 作用

解决HTTP无状态的特点，在客户端和服务器的交互过程中，记录用户特征。

### cookie技术的四个部分

1. HTTP**响应报文**中附带一个cookie首部行
2. HTTP**请求报文**中附带一个cookie首部行
3. 客户端保留一个**cookie文件**，由浏览器进行管理
4. WEB站点后端的数据库

### cookie的工作流程

1. 用户访问网站，站点对该用户生成一个唯一的标识（假设为123），以该标识作为索引在后端数据库中生成一个表项
2. 服务器返回的**响应报文**中，包含一个cookie首部行：```Set-cookie:123```
3. 用户接收到该响应后，在它管理的*cookie文件*中添加一行，包括该服务器的主机名称和cookie值（123）
4. 该用户后续访问该网站时，会附带一个**cookie首部行**：```cookie:123```
5. 网站根据接收到的cookie值，做出相应的响应

## Web缓存
>   Web缓存器Web Cache，也称为代理服务器

### 使用Web缓存的原因

- 大大减少客户端请求的响应时间
- 减少服务器的负担
- 从整体上降低因特网的*总流量*，从而改善所有应用的性能

### Web缓存的工作流程

1. 客户端发送请求
2. 代理服务器检查本地是否有该请求的缓存副本：
    - 若有，则直接返回
    - 若没有，则向初始请求服务器发送请求。接收返回的内容后，向客户端返回，并在本地拷贝一份

### CDN
> Content Delivery Network，即内容分发网络

依靠部署在各地的边缘服务器，通过中心平台的**负载均衡**、**内容分发**、**调度**等功能模块，使用户**就近获取所需内容**

# 电子邮件

## 电子邮件系统的组成部分

- 用户代理
- 邮件服务器
- SMTP简单邮件传输协议

## 工作方式

- 邮件服务器之间使用SMTP
- 用户代理与邮件服务器之间使用SMTP或邮件访问协议，如：POP3、HTTP、IMAP

## SMTP和HTTP的比较

- SMTP是**推**协议；HTTP是**拉**协议
- SMTP的报文必须是**7位ASCII码**形式，若包含其他字符必须先转义；HTTP没有这种限制
- SMTP把所有对象放在一个报文之中；HTTP把对象封装到每个报文之中


# DNS协议
> 域名系统，Domain Name System

## 概念

- 作用：**将域名映射为IP地址**
- 选用的运输层协议：UDP
- 常用端口：53
- 含义：
  - 一个由分层的DNS服务器实现的**分布式数据库**
  - 一个使主机能查询分布式数据库的**应用层协议**

## 层次

共分为三层：
1. 最顶层：根DNS服务器。共有四百多个，由13个不同的组织管理
2. 顶级域DNS服务器，对应每个*顶级域*和*国家域*
    - 顶级域：.com、.org、.edu
    - 国家与：.cn、.uk、.jp
3. 权威DNS服务器：对应每个组织（如大学、公司等）提供的自己组织可供公共访问的记录

## 查询方式

以A向B查询举例：
- 递归查询：B向上级服务器进行查询，得到结果后，向A返回结果
- 迭代查询：B向上级发送请求并直接将请求结果发送给A

实际查询过程中：
- 主机到本地DNS服务器的查询是递归方式的
- 其余查询都是迭代方式的


# P2P文件分发

## 含义

每位用户在下载资源的同时，也充当*资源提供者*的身份为其他用户*提供上载*

举例：
有一个资源Data，共分为100个块。

A已经下载了0-10这是个块，在下载后面资源时，有其他用户需要下载0-10这些资源块，则此时A可以作为服务端提供资源。

## 意义

- 减轻了服务器的负担
- 减少了分发时间，提高了下载速度

## BitTorrent
> 一种流行的用于文件分发的P2P协议

- 参与一个特定文件f的**所有对等方的集合**称为一个***洪流（torrent）***。每个对等方拥有改文件的某些块。
- 每个*洪流*有一个基础设施节点，称为***追踪器***，当一个对等方加入*洪流*时，需要向追踪器注册自己，并周期性通知它自己仍在洪流中。
- 当一个新的对等方A加入*洪流*时，追踪器随机选择洪流的一个子集，并将这部分对等方的IP地址发给A。
- A与上述子集中的所有对等方建立TCP连接，连接建立成功的称为***邻近对等方***。邻近对等方随时间改变
- 向哪个邻近对等方先请求块？使用***最稀缺优先***思路：先请求邻居中副本数量最少的块
- 向哪个请求对等方先发送块？测量接收数据的速率，向接收速率最高的邻居发送块。同时，每隔一段时间随机向某个邻居发送块