---
category: 前端
tag:
  - React
---

# commit 阶段

renderer 工作的阶段被称为 commit 阶段，该阶段会把所有的副作用 commit 到宿主 UI 上。
与 render 流程不同，commit 流程是同步的，一旦开始不会被打断。

## 流程概览

整个 commit 阶段分为三个子阶段：

1. beforeMutation
2. Mutation
3. Fiber 树切换，Layout

首先会通过 wip HostRootFiber 的 flags 和 subtreeFlags 判断是否有副作用，如果没有，则跳过 1 和 2。

commit 的三个子阶段会进行自下而上的 subtreeFlags 消费过程：

1. 首先，向下遍历找到执行 flags 操作的节点，需要满足两个条件之一：

- 叶子节点
- 子 fiberNode 不包含本次更新对应的 flags

在遍历过程中，某些节点会进行特定的操作，见下文。

2. 执行 flags 对应的操作。

- 如果当前 fiberNode 存在兄弟节点，则对兄弟节点重复该流程。
- 若不存在，返回父节点，直到遍历到 HostRootFiber 为止

## Effects list 和 subtreeFlags

在 Fiber 架构的早期版本中没有 subtreeFlags，使用一个链表 Effects list 保存被标记副作用的 fiberNode。，在 commit 阶段也无需遍历 fiber tree，只需遍历链表即可。

### 使用 subtreeFlags 的原因

开启并发的 Suspense 需要遍历子树。

开启并发的 Suspense 和 Legacy Suspense 的区别是：

- Legacy Suspense 中，当 Suspense 内同时存在异步组件和同步内容时，同步内容会先加载，组件的 useEffect 也会执行，但为了 UI 上的不展示，此时同步元素会添加 `display:none`
- 并发 Suspense 中，同步内容不会被先渲染，也不会执行 useEffect 回调

## beforeMutation

## Mutation

## Layout
