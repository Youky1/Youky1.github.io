---
category: 前端
tag:
  - React
---

# commit 阶段

renderer 工作的阶段被称为 commit 阶段，该阶段会把所有的副作用 commit 到宿主 UI 上。
与 render 流程不同，commit 流程是同步的，一旦开始不会被打断。

## 流程概览

整个 commit 阶段分为三个子阶段：

1. beforeMutation
2. Mutation
3. Fiber 树切换，Layout

首先会通过 wip HostRootFiber 的 flags 和 subtreeFlags 判断是否有副作用，如果没有，则跳过 1 和 2。

commit 的三个子阶段会进行自下而上的 subtreeFlags 消费过程：

1. 首先，向下遍历找到执行 flags 操作的节点，需要满足两个条件之一：

- 叶子节点
- 子 fiberNode 不包含本次更新对应的 flags

2. 执行 flags 对应的操作。

- 如果当前 fiberNode 存在兄弟节点，则对兄弟节点重复该流程。
- 若不存在，返回父节点，直到遍历到 HostRootFiber 为止

## Effects list 和 subtreeFlags

在 Fiber 架构的早期版本中没有 subtreeFlags，而是使用一个链表 Effects list 保存被标记副作用的 fiberNode。，在 commit 阶段也无需遍历 fiber tree，只需遍历链表即可。

### 使用 subtreeFlags 的原因

开启并发的 Suspense 需要遍历子树。

开启并发的 Suspense 和 Legacy Suspense 的区别是：

- Legacy Suspense 中，当 Suspense 内同时存在异步组件和同步内容时，同步内容会先加载，组件的 useEffect 也会执行，但为了 UI 上的不展示，此时同步元素会添加 `display:none`
- 并发 Suspense 中，同步内容不会被先渲染，也不会执行 useEffect 回调

## beforeMutation

beforeMutation阶段主要处理两种节点：

- 对于类组件，执行其 `getSnapshotBeforeUpdate` 生命周期函数
- 对于HostRoot，清空其挂载内容，以便Mutation阶段的渲染

## Mutation

### 删除DOM元素

删除DOM元素的操作发生在向下遍历的过程中，会对标记了删除的节点进行删除DOM操作。执行删除操作的是 `commitDeletion` 方法，除了删除DOM还需要触发子组件的生命周期（Hook）、ref卸载等

### 插入、移动DOM元素

插入（mount）和移动（update）对应的flag标记是相同的，都是Placement

插入和移动DOM元素的流程 主要分为三个步骤：

1. 向上寻找本次操作元素的父级DOM，它的类型必须是HostComponent、HostRoot、HostPortal中的一种
2. 查找插入位置的兄弟元素
3. 如果有兄弟，使用 `parentNode.insertBefore` 插入到它之前；如果没有，使用 `parentNode.appendChild` 添加到末尾




## Layout
